name: Kaiten Board Manager

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - list-boards
          - list-cards
          - create-card
          - update-card
          - move-card
          - close-card
      board_id:
        description: 'Board ID (for list-cards, create-card)'
        required: false
        type: string
      card_id:
        description: 'Card ID (for update-card, move-card, close-card)'
        required: false
        type: string
      title:
        description: 'Card title (for create-card, update-card)'
        required: false
        type: string
      description:
        description: 'Card description (for create-card, update-card)'
        required: false
        type: string
      column_id:
        description: 'Column/Lane ID (for create-card, move-card)'
        required: false
        type: string

jobs:
  kaiten:
    runs-on: ubuntu-latest
    env:
      # Try different API base URLs - Kaiten may use regional endpoints
      KAITEN_API: "https://kaiten.io/api/latest"
    steps:
      - name: Test API Connectivity
        run: |
          echo "üîç Testing Kaiten API at aldureid.kaiten.ru..."
          API_KEY="${{ secrets.KAITEN_API_KEY }}"
          BASE_URL="https://aldureid.kaiten.ru/api/latest"
          
          echo ">>> Testing /users/current:"
          curl -s --max-time 10 -w "\nHTTP: %{http_code}" \
            -H "Authorization: Bearer $API_KEY" \
            "$BASE_URL/users/current" 2>&1
          
          echo ""
          echo ">>> Testing /spaces:"
          curl -s --max-time 10 -w "\nHTTP: %{http_code}" \
            -H "Authorization: Bearer $API_KEY" \
            "$BASE_URL/spaces" 2>&1
          
          echo ""
          echo ">>> Testing space 710660 boards:"
          curl -s --max-time 10 -w "\nHTTP: %{http_code}" \
            -H "Authorization: Bearer $API_KEY" \
            "$BASE_URL/spaces/710660/boards" 2>&1

      - name: List Boards
        if: ${{ github.event.inputs.action == 'list-boards' }}
        run: |
          echo "üìã Fetching boards from space 710660..."
          response=$(curl -s --max-time 15 -H "Authorization: Bearer ${{ secrets.KAITEN_API_KEY }}" \
            "https://aldureid.kaiten.ru/api/latest/spaces/710660/boards" 2>&1)
          echo "$response" | jq -r '.[] | "ID: \(.id) | Name: \(.title)"' 2>/dev/null || echo "$response"

      - name: List Cards on Board
        if: ${{ github.event.inputs.action == 'list-cards' }}
        run: |
          echo "üÉè Fetching cards from board ${{ github.event.inputs.board_id }}..."
          response=$(curl -s -H "Authorization: Bearer ${{ secrets.KAITEN_API_KEY }}" \
            "https://kaiten.io/api/latest/boards/${{ github.event.inputs.board_id }}/cards")
          echo "$response" | jq -r '.[] | "ID: \(.id) | \(.title) | Column: \(.column_id)"' || echo "$response"

      - name: Create Card
        if: ${{ github.event.inputs.action == 'create-card' }}
        run: |
          echo "‚ûï Creating card on board ${{ github.event.inputs.board_id }}..."
          response=$(curl -s -X POST \
            -H "Authorization: Bearer ${{ secrets.KAITEN_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{
              "title": "${{ github.event.inputs.title }}",
              "description": "${{ github.event.inputs.description }}",
              "column_id": ${{ github.event.inputs.column_id }}
            }' \
            "https://kaiten.io/api/latest/boards/${{ github.event.inputs.board_id }}/cards")
          echo "$response" | jq '.' || echo "$response"

      - name: Update Card
        if: ${{ github.event.inputs.action == 'update-card' }}
        run: |
          echo "‚úèÔ∏è Updating card ${{ github.event.inputs.card_id }}..."
          response=$(curl -s -X PATCH \
            -H "Authorization: Bearer ${{ secrets.KAITEN_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{
              "title": "${{ github.event.inputs.title }}",
              "description": "${{ github.event.inputs.description }}"
            }' \
            "https://kaiten.io/api/latest/cards/${{ github.event.inputs.card_id }}")
          echo "$response" | jq '.' || echo "$response"

      - name: Move Card
        if: ${{ github.event.inputs.action == 'move-card' }}
        run: |
          echo "üîÑ Moving card ${{ github.event.inputs.card_id }} to column ${{ github.event.inputs.column_id }}..."
          response=$(curl -s -X PATCH \
            -H "Authorization: Bearer ${{ secrets.KAITEN_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{"column_id": ${{ github.event.inputs.column_id }}}' \
            "https://kaiten.io/api/latest/cards/${{ github.event.inputs.card_id }}")
          echo "$response" | jq '.' || echo "$response"

      - name: Close Card (Archive)
        if: ${{ github.event.inputs.action == 'close-card' }}
        run: |
          echo "‚úÖ Closing card ${{ github.event.inputs.card_id }}..."
          response=$(curl -s -X PATCH \
            -H "Authorization: Bearer ${{ secrets.KAITEN_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{"archived": true}' \
            "https://kaiten.io/api/latest/cards/${{ github.event.inputs.card_id }}")
          echo "$response" | jq '.' || echo "$response"
