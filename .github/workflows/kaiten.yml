name: Kaiten Board Manager

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - list-boards
          - list-cards
          - create-card
          - update-card
          - move-card
          - close-card
      board_id:
        description: 'Board ID (for list-cards, create-card)'
        required: false
        type: string
      card_id:
        description: 'Card ID (for update-card, move-card, close-card)'
        required: false
        type: string
      title:
        description: 'Card title (for create-card, update-card)'
        required: false
        type: string
      description:
        description: 'Card description (for create-card, update-card)'
        required: false
        type: string
      column_id:
        description: 'Column/Lane ID (for create-card, move-card)'
        required: false
        type: string

jobs:
  kaiten:
    runs-on: ubuntu-latest
    env:
      # Try different API base URLs - Kaiten may use regional endpoints
      KAITEN_API: "https://kaiten.io/api/latest"
    steps:
      - name: Test API Connectivity
        run: |
          echo "üîç Testing Kaiten API connectivity..."
          # Kaiten uses different subdomains for app vs marketing site
          for url in \
            "https://kaiten.ru/api/latest/users/current" \
            "https://app.kaiten.ru/api/latest/users/current" \
            "https://kaiten.io/api/v1/users/current" \
            "https://app.kaiten.io/api/v1/users/current" \
            "https://eu.kaiten.io/api/latest/users/current"; do
            echo ""
            echo ">>> Trying: $url"
            response=$(curl -s --max-time 10 -w "\nHTTP_CODE:%{http_code}" \
              -H "Authorization: Bearer ${{ secrets.KAITEN_API_KEY }}" \
              "$url" 2>&1)
            http_code=$(echo "$response" | grep "HTTP_CODE:" | cut -d: -f2)
            body=$(echo "$response" | grep -v "HTTP_CODE:")
            echo "HTTP Code: $http_code"
            echo "Response: $body" | head -c 500
          done

      - name: List Boards
        if: ${{ github.event.inputs.action == 'list-boards' }}
        run: |
          echo "üìã Fetching all boards..."
          for base in "https://kaiten.io/api/latest" "https://app.kaiten.io/api/latest" "https://kaiten.ru/api/latest"; do
            echo "Trying $base..."
            response=$(curl -s --max-time 15 -H "Authorization: Bearer ${{ secrets.KAITEN_API_KEY }}" \
              "$base/boards" 2>&1)
            if echo "$response" | jq -e '.' > /dev/null 2>&1; then
              echo "‚úÖ Success with $base"
              echo "$response" | jq -r '.[] | "ID: \(.id) | Name: \(.title)"' || echo "$response"
              exit 0
            fi
          done
          echo "‚ùå All endpoints failed"
          exit 1

      - name: List Cards on Board
        if: ${{ github.event.inputs.action == 'list-cards' }}
        run: |
          echo "üÉè Fetching cards from board ${{ github.event.inputs.board_id }}..."
          response=$(curl -s -H "Authorization: Bearer ${{ secrets.KAITEN_API_KEY }}" \
            "https://kaiten.io/api/latest/boards/${{ github.event.inputs.board_id }}/cards")
          echo "$response" | jq -r '.[] | "ID: \(.id) | \(.title) | Column: \(.column_id)"' || echo "$response"

      - name: Create Card
        if: ${{ github.event.inputs.action == 'create-card' }}
        run: |
          echo "‚ûï Creating card on board ${{ github.event.inputs.board_id }}..."
          response=$(curl -s -X POST \
            -H "Authorization: Bearer ${{ secrets.KAITEN_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{
              "title": "${{ github.event.inputs.title }}",
              "description": "${{ github.event.inputs.description }}",
              "column_id": ${{ github.event.inputs.column_id }}
            }' \
            "https://kaiten.io/api/latest/boards/${{ github.event.inputs.board_id }}/cards")
          echo "$response" | jq '.' || echo "$response"

      - name: Update Card
        if: ${{ github.event.inputs.action == 'update-card' }}
        run: |
          echo "‚úèÔ∏è Updating card ${{ github.event.inputs.card_id }}..."
          response=$(curl -s -X PATCH \
            -H "Authorization: Bearer ${{ secrets.KAITEN_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{
              "title": "${{ github.event.inputs.title }}",
              "description": "${{ github.event.inputs.description }}"
            }' \
            "https://kaiten.io/api/latest/cards/${{ github.event.inputs.card_id }}")
          echo "$response" | jq '.' || echo "$response"

      - name: Move Card
        if: ${{ github.event.inputs.action == 'move-card' }}
        run: |
          echo "üîÑ Moving card ${{ github.event.inputs.card_id }} to column ${{ github.event.inputs.column_id }}..."
          response=$(curl -s -X PATCH \
            -H "Authorization: Bearer ${{ secrets.KAITEN_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{"column_id": ${{ github.event.inputs.column_id }}}' \
            "https://kaiten.io/api/latest/cards/${{ github.event.inputs.card_id }}")
          echo "$response" | jq '.' || echo "$response"

      - name: Close Card (Archive)
        if: ${{ github.event.inputs.action == 'close-card' }}
        run: |
          echo "‚úÖ Closing card ${{ github.event.inputs.card_id }}..."
          response=$(curl -s -X PATCH \
            -H "Authorization: Bearer ${{ secrets.KAITEN_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{"archived": true}' \
            "https://kaiten.io/api/latest/cards/${{ github.event.inputs.card_id }}")
          echo "$response" | jq '.' || echo "$response"
